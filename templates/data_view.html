{% extends "base.html" %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<h3 class="mb-4"><i class="fas fa-database me-2"></i> {{ title }}</h3>
<p class="text-muted">
    Dit is een overzicht van alle ruwe data in de <code>sensor_data</code> tabel. 
    Er zijn momenteel <strong>{{ data|length }}</strong> metingen opgeslagen.
</p>

<div class="alert alert-danger d-flex justify-content-between align-items-center" role="alert">
    <div>
        <i class="fas fa-exclamation-triangle me-2"></i>
        <strong>Gevaarlijke Zone:</strong> Deze actie zal <strong>alle</strong> sensordata permanent verwijderen!
    </div>
    <form action="{{ url_for('clear_database') }}" method="post" onsubmit="return handleClearDatabase(event);">
        <!-- Dit is een verborgen inputveld. JavaScript vult hier het wachtwoord in voordat het formulier wordt verstuurd. -->
        <input type="hidden" name="password" id="password-input">
        
        <button type="submit" class="btn btn-danger btn-sm">
            <i class="fas fa-trash-alt me-1"></i> Wis Database
        </button>
    </form>
</div>

<div class="card shadow-sm mt-4">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        {# Dit is een loop die de kolomnamen print die we vanuit Python hebben meegegeven #}
                        {% for col_name in columns %}
                            <th scope="col">{{ col_name }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {# Dit is een dubbele loop: we loopen eerst door elke rij (meting) #}
                    {% for row in data %}
                    <tr>
                        {# En dan loopen we door elke waarde binnen die rij #}
                        {% for value in row %}
                            <td>{{ value }}</td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
async function handleClearDatabase(event) {
    // Voorkom dat het formulier direct wordt verstuurd
    event.preventDefault(); 

    // Vraag de gebruiker om het wachtwoord
    const password = prompt("Voer het wachtwoord in om de database te wissen:");

    // Stop als de gebruiker op 'Annuleren' klikt
    if (password !== null) {
        // Maak een FormData object om de data te versturen, net als een echt formulier
        const formData = new FormData();
        formData.append('password', password);

        try {
            // Stuur het verzoek naar de server op de achtergrond
            const response = await fetch("{{ url_for('clear_database') }}", {
                method: 'POST',
                body: formData
            });

            // Wacht op de JSON-response van de server
            const result = await response.json();

            // Toon de melding van de server
            showFlashMessage(result.message, result.status);

            // Als het wissen succesvol was, laad de pagina opnieuw om de lege tabel te tonen
            if (result.status === 'success') {
                // Wacht een klein moment zodat de gebruiker de melding kan lezen, en herlaad dan.
                setTimeout(() => {
                    window.location.reload();
                }, 1500); // 1.5 seconden wachttijd
            }

        } catch (error) {
            console.error('Er is een fout opgetreden:', error);
            showFlashMessage('Kon de server niet bereiken. Probeer het later opnieuw.', 'danger');
        }
    }
}

// Hulpfunctie om een flash-bericht dynamisch aan de pagina toe te voegen
function showFlashMessage(message, category) {
    const flashContainer = document.getElementById('main-content-area');
    const alertHtml = `<div class="alert alert-${category} alert-dismissible fade show" role="alert">${message}<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>`;
    flashContainer.insertAdjacentHTML('afterbegin', alertHtml);
}
</script>
{% endblock %}