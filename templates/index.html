{% extends "base.html" %}

{% block title %}Live Dashboard{% endblock %}

{% block content %}
<h3 class="mb-4"><i class="fas fa-chart-line me-2"></i> Live Dashboard</h3>

<div class="row g-4 mt-2" id="data-widgets-container">
    </div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card shadow-sm">
            <div class="card-body">
                <h5 class="card-title"><i class="fas fa-chart-area me-2"></i> Dagelijks Overzicht (Temperatuur)</h5>
                <div style="height: 350px;">
                    <canvas id="dailySummaryChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // --- GLOBAL DATA & THRESHOLDS ---
    let globalSensorData = {
        "Soil Moisture": { 
            // Data wordt de eerste keer ingeladen via Jinja, daarna via AJAX.
            value: "{{ soil_moisture | default(0.0) }}", 
            unit: "%", icon: "fa-water", color: "#00bcd4", 
            description: "Bodemvochtigheid: Essentieel voor wateropname van de plant.", 
            min_alert: 60, max_alert: 95 
        },
        "Temperature": { 
            value: "{{ temperature | default(0.0) }}", unit: "°C", icon: "fa-temperature-three-quarters", color: "#4caf50", 
            description: "Luchttemperatuur: Beïnvloedt de snelheid van fotosynthese en transpiratie.", 
            min_alert: 22, max_alert: 34 
        },
        "Humidity": { 
            value: "{{ humidity | default(0.0) }}", unit: "%", icon: "fa-droplet", color: "#00bcd4", 
            description: "Luchtvochtigheid: Relatief aan transpiratie van de plant.", 
            min_alert: 65, max_alert: 90 
        },
        "pH Level": { 
            value: "{{ ph_level | default(0.0) }}", unit: "", icon: "fa-square-check", color: "#4caf50", 
            description: "Water pH (zuurgraad): Bepaalt hoe goed de plant voedingsstoffen kan opnemen.", 
            min_alert: 5.5, max_alert: 6.5 
        },
        "Light Level": { 
            value: "{{ light_level | default(0) }}", unit: " lux", icon: "fa-sun", color: "#ffc107", 
            description: "Lichtintensiteit: De energiebron voor fotosynthese.", 
            min_alert: 400, max_alert: 700 
        }
    };
    
    // De initiële grafiek data (nodig voor de eerste render)
    // tojson | safe zorgt voor correcte JSON-conversie
    const chartLabels = JSON.parse('{{ chart_labels | tojson | safe }}');
    const chartData = JSON.parse('{{ chart_data | tojson | safe }}');
    let dailySummaryChart = null; 

    // ---------------------------------------------------------------------------------------
    // --- UTILITY & CORE LOGIC FUNCTIONS (Overgenomen uit de oude index.html) ---
    // ---------------------------------------------------------------------------------------

    // Functie om advies te geven op basis van de alarmstatus
    function getAdvice(name, value, min, max) {
        if (value >= min && value <= max) {
            return "Waarde is optimaal. Geen actie vereist.";
        }

        let action = "";
        let problem = "";
        
        switch (name) {
            case "Soil Moisture":
                if (value < min) { problem = "De grond is te droog."; action = "Start de irrigatiepomp via de Controls-pagina om water toe te voegen."; }
                else if (value > max) { problem = "De grond is te nat."; action = "Schakel de pomp uit en controleer drainage."; }
                break;
            case "Temperature":
                if (value < min) { problem = "De temperatuur is te laag."; action = "Controleer de verwarming (indien aanwezig) of sluit ramen/ventilatie."; }
                else if (value > max) { problem = "De temperatuur is te hoog."; action = "Verhoog de ventilatie (Fans) via de Controls-pagina."; }
                break;
            case "Humidity":
                if (value < min) { problem = "De lucht is te droog."; action = "Verneveling starten (indien aanwezig) of geef water aan de planten."; }
                else if (value > max) { problem = "De lucht is te vochtig."; action = "Verhoog de ventilatie (Fans) of controleer op lekkages."; }
                break;
            case "pH Level":
                if (value < min) { problem = "De pH is te laag (zuur)."; action = "Voeg een basische oplossing toe (pH Up) aan het waterreservoir."; }
                else if (value > max) { problem = "De pH is te hoog (basisch)."; action = "Voeg een zure oplossing toe (pH Down) aan het waterreservoir."; }
                break;
            case "Light Level":
                if (value < min) { problem = "Er is te weinig licht."; action = "Schakel de kweeklampen (Lights) in via de Controls-pagina."; }
                else if (value > max) { problem = "Er is te veel licht."; action = "Schakel de kweeklampen uit of zorg voor schaduw."; }
                break;
            default:
                action = "Geen specifiek advies beschikbaar.";
        }
        
        return `${problem} **Advies:** ${action}`;
    }


    function generateWidgetHTML(name, data) {
        let alertClass = '';
        const value = parseFloat(data.value); 
        
        if (isNaN(value)) {
             console.error(`Invalid sensor value for ${name}: ${data.value}.`);
             return ''; 
        }
        
        const adviceText = getAdvice(name, value, data.min_alert, data.max_alert);
        const isAlert = value < data.min_alert || value > data.max_alert;
        
        if (value < data.min_alert) {
            alertClass = 'alert-low';
        } else if (value > data.max_alert) {
            alertClass = 'alert-high';
        }

        // Formattering van de displaywaarde
        let displayValue = value.toFixed(2);
        if (name === 'Light Level') {
            displayValue = value.toFixed(0); 
        } else if (name === 'pH Level') {
            displayValue = value.toFixed(2);
        }
        
        // Let op: De harde col-lg-2-4 / 20% breedte die je had, kan problemen geven met Bootstrap. 
        // We laten de harde style: flex: 0 0 auto; width: 20%; staan om 5 kolommen te garanderen, 
        // maar dit is geen standaard Bootstrap-klasse.
        return `
            <div class="col-lg-2-4 col-md-6" style="flex: 0 0 auto; width: 20%;">
                <a href="/detail/${name}" style="text-decoration: none; color: inherit;">
                    <div class="data-widget ${alertClass}">
                        <div class="icon-box" style="background-color: ${data.color};">
                            <i class="fas ${data.icon}"></i>
                        </div>
                        
                        <h6 class="text-muted" 
                            data-bs-toggle="tooltip" 
                            data-bs-placement="top" 
                            title="${data.description}">
                            ${name} <i class="fas fa-info-circle small ms-1"></i>
                        </h6>
                        
                        <h2 class="mb-0">${displayValue}<span style="font-size: 1rem; opacity: 0.7;">${data.unit}</span></h2>
                        
                        ${isAlert ? `<div class="advice-box">
                                <i class="fas fa-exclamation-triangle me-1"></i> ${adviceText}
                            </div>` : `<small class="text-secondary">${data.description.split(':')[0]}</small>`}
                        
                    </div>
                </a>
            </div>
        `;
    }
    
    // Renders the data widgets on the Dashboard view
    function renderWidgets() {
        const container = document.getElementById('data-widgets-container');
        if (!container) return; // Stop als we niet op het Dashboard zijn

        let html = '';
        for (const [name, data] of Object.entries(globalSensorData)) {
            html += generateWidgetHTML(name, data);
        }
        container.innerHTML = html;
        
        // BELANGRIJK: Initialiseer alle Bootstrap Tooltips na het renderen!
        const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]')
        if (typeof bootstrap !== 'undefined' && bootstrap.Tooltip) {
             [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl))
        }
    }

    // Sets the current time for the "Last Update" span
    function updateTime() {
        const now = new Date();
        const options = { hour: '2-digit', minute: '2-digit', second: '2-digit' }; // Vereenvoudigd naar alleen tijd
        document.getElementById('last-update-time').textContent = now.toLocaleTimeString('nl-NL', options);
    }
    
    // ----------------------------------------------------
    // --- AJAX LIVE DATA UPDATE FUNCTIES ---
    // ----------------------------------------------------
    
    function fetchAndUpdateData() {
        fetch('/api/latest_data') 
            .then(response => response.json())
            .then(data => {
                const keyMap = {
                    soil_moisture: "Soil Moisture",
                    temperature: "Temperature",
                    humidity: "Humidity",
                    ph_level: "pH Level",
                    light_level: "Light Level"
                };

                for (const [key, widgetName] of Object.entries(keyMap)) {
                    if (data.hasOwnProperty(key)) {
                        // Update de globale data
                        globalSensorData[widgetName].value = data[key].toString(); 
                    }
                }
                
                // Her-render de widgets met de nieuwe data
                renderWidgets(); 
                updateTime();
            })
            .catch(error => console.error('Fout bij het ophalen van data (widgets):', error));
    }
    
    function fetchAndUpdateChart() {
        fetch('/api/chart_data') 
            .then(response => response.json())
            .then(data => {
                if (dailySummaryChart && dailySummaryChart.data.datasets.length > 0) {
                    // Update de grafiek data en labels
                    dailySummaryChart.data.labels = data.labels;
                    dailySummaryChart.data.datasets[0].data = data.data;
                    dailySummaryChart.update(); // Vertel Chart.js om opnieuw te tekenen
                }
            })
            .catch(error => console.error('Fout bij het ophalen van data (grafiek):', error));
    }

    function initChart(initialLabels, initialData) {
        const ctx = document.getElementById('dailySummaryChart')?.getContext('2d');
        if (ctx) {
            dailySummaryChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: initialLabels, 
                    datasets: [{
                        label: 'Temperatuur (°C)',
                        data: initialData,
                        borderColor: '#4caf50',
                        backgroundColor: 'rgba(76, 175, 80, 0.1)', 
                        tension: 0.4, 
                        fill: true,
                        pointRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: false, max: 40, grid: { display: true } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }
    }

    // --- INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', function() {
        // Initialiseer de grafiek met de data die door Flask/Jinja is ingeladen
        initChart(chartLabels, chartData); 
        
        // Render de widgets de eerste keer
        renderWidgets();

        // Start de realtime updates (elke 5 seconden)
        setInterval(fetchAndUpdateData, 5000); 
        setInterval(fetchAndUpdateChart, 5000); 
    });
</script>
{% endblock %}